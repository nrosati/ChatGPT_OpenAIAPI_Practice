@page "/"
@inject Services.GPTService GptService
@inject IJSRuntime JSRuntime

<h3>Ask GPT</h3>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        @foreach (var dialog in dialogs)
        {
            <div class="chat-message @(dialog.IsPrompt ? "user-message" : "bot-message")">
                @if (dialog.IsPrompt)
                {
                    <span class="message-text">@dialog.MessageText</span>
                    <img src="images/User.webp" class="message-icon" alt="User icon" />
                }
                else
                {
                    <img src="images/Robot.webp" class="message-icon" alt="Bot icon" />
                    <span class="message-text">@dialog.MessageText</span>
                }
            </div>
        }
    </div>

    <div class="chat-input">
        <textarea rows="1" @bind="userInput" placeholder="Type your question..."></textarea>
        <button @onclick="GetResponse" disabled="@isLoading">@(isLoading ? "..." : "Ask")</button>
    </div>
</div>

@code {
    private string userInput = "";
    private string myPrompt = "";

    private bool _shouldScroll;
    private bool isLoading;

    private List<Dialog> dialogs = new();

    private async Task GetResponse()
    {
        if (string.IsNullOrWhiteSpace(userInput))
            return;

        isLoading = true;

        myPrompt = userInput;
        dialogs.Add(new Dialog { MessageText = myPrompt, IsPrompt = true });
        userInput = "";
        _shouldScroll = true;

        try
        {
            var response = await GptService.GetCompletionAsync(myPrompt);

            var content = response?.Choices?.FirstOrDefault()?.Message?.Content
                          ?? "(no response)";

            dialogs.Add(new Dialog { MessageText = content, IsPrompt = false });
            _shouldScroll = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private class Dialog
    {
        public string MessageText { get; set; } = "";
        public bool IsPrompt { get; set; } = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldScroll)
        {
            _shouldScroll = false;
            await JSRuntime.InvokeVoidAsync("scrollToBottom");
        }
    }
}
